<!DOCTYPE html><html><head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-179068877-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-179068877-2');
</script>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width">
<title>さばえものづくり博覧会</title>
<link rel='stylesheet' href='https://code4sabae.github.io/leaflet-mjs/leaflet.css'/>
<script type="module">
    import util from "https://taisukef.github.io/util/util.mjs";
    import L from 'https://code4sabae.github.io/leaflet-mjs/leaflet.mjs'

    window.onload = async () => {
      const url = "https://push.sabae.cc/524.csv";
      const data = await util.fetchCSVtoJSON(url);
      
      // 新しいものを先
      data.sort((a, b) => {
        const ta = new Date(a.lastUpdate).getTime();
        const tb = new Date(b.lastUpdate).getTime();
        return tb - ta;
      });

      const enc = s => {
        s = s.replace(/&/g, '&amp;');
        s = s.replace(/</g, '&lt;');
        s = s.replace(/>/g, '&gt;');
        return s;
      };

      const itemsToHTML = (items) => {
        return items.map(d => `<a href=detail.html#${enc(d.id)}>${enc(d.事業所名)}</a>`).join(" / ");
      };
      
      const show = () => {
        const key = input_search.value;
        if (key.length === 0) {
          all.innerHTML = "";
          return;
        }
        const items = data.filter(d => {
          for (const c in d) {
            const val = d[c];
            if (val.indexOf(key) >= 0) {
              return true;
            }
          }
          return false;
        });
        all.innerHTML = itemsToHTML(items);
      };
      //show();
      
      // const getUniqueArray = (arr, funcGetKey) => [...new Map(arr.map(v => [funcGetKey(v), v])).values()];
      /// const types = [...new Map(data.map(v => [v.業種, v])).values()];
      // const types = getUniqueArray(data, d => d.業種);
      const typeset = new Set();
      for (const n of data) {
        const t = n.業種;
        // const t2 = util.splitString(t, "　、");
        const t2 = t.split(",").filter((t) => t.length > 0);
        t2.forEach(d => typeset.add(d.trim()));
      }
      const types = Array.from(typeset.values());
      // console.log(types);

      types.forEach(d => {
        const type = d; // .業種;
        const a = document.createElement("a");
        a.textContent = type;
        a.onclick = function() {
          //input_search.value = this.textContent;
          //show();
          const items = data.filter(d => d.業種 === this.textContent);
          alltags.innerHTML = itemsToHTML(items);
        };
        tags.appendChild(a);
      });
      input_search.onkeyup = btn_search.onclick = () => show();

      // 新着
      const anews = [];
      const formatDate = (d) => {
        return "<span class=date>" + d.substring(0, d.indexOf("T")).replace(/-/g, ".") + "</span>";
      }
      for (let i = 0; i < Math.min(data.length, 5); i++) {
        const d = data[i];
        anews.push(`<a href=detail.html#${d.id}>${formatDate(d.lastUpdate)} ${d.事業所名} さんが、企業情報を更新しました。</a>`);
      }
      //console.log(anews);
      divnews.innerHTML = anews.join("<br>");

      // 新着画像
      const anewsimg = [];
      for (let i = 0; i < data.length; i++) {
        const d = data[i];
        let imgs = [d.写真URL1, d.写真URL2, d.写真URL3].filter((i) => i != null && i.length > 0);
        if (imgs.length > 0) {
          anewsimg.push(`<a href=detail.html#${d.id}><div style="background-image:url(${imgs[0]})"></div></a>`);
          if (anewsimg.length === 5)
            break;
        }
      }
      //console.log(anews);
      divnewsimg.innerHTML = anewsimg.join("");

      // map
      const map = L.map('divmap');
      // set 国土地理院地図 https://maps.gsi.go.jp/development/ichiran.html
      L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png", {
        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>"',
        //maxZoom: 18,
        center: [35.94363, 136.188992],
        //zoom: 15,
      }).addTo(map);
      map.setView([35.961, 136.228], 12);
      
      let iconlayer = L.layerGroup();
      iconlayer.addTo(map);
      const lls = [];
      data.filter((d) => d.緯度 && d.経度).forEach((d) => {
        const ll = [ d.緯度, d.経度 ];
        //const fillColor = d.業種.indexOf("料飲") >= 0 ? "#BB4459" : (d.業種.indexOf("眼鏡") >= 0 ? "#48A0BE" : "#BBC459");
        const fillColor = d.業種.indexOf("料飲") >= 0 ? "#BB4459" : "#48A0BE";
        const marker = L.circleMarker(ll, { title: d.事業所名, fillColor, stroke: false, radius: 8, fillOpacity: 1 });
        marker.bindPopup(`<a href=detail.html#${d.id}>${d.事業所名}</a><br>${d.業種}</a>`);
        iconlayer.addLayer(marker);
        lls.push(ll);
      });
      
      /*
      if (lls.length) {
        map.fitBounds(lls);
      }
      */
    };
  </script>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@300&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans+Condensed:wght@300&display=swap" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="style.css">
<script type="module" src="./footer.js"></script>
</head>
<body>
  <a name="top"></a>
  <div id="header">
    <a href="#greeting"><img id="btn_greeting" class="fuwafuwa" src="img/topaisatsu.svg"></a>
    <img id="main_logo" src="img/main.svg">
    <ul id="main_menu">
      <li><a href="#greeting">ABOUT</a></li>
      <li><a href="#member">MEMBER</a></li>
      <li><a href="#information">INFORMATION</a></li>
      <li><a href="#contact">CONTACT</a></li>
      <li><a href=https://www.facebook.com/sabaemonohaku><img src="img/fb_icon_w.svg"></a></li>
    </ul>
  </div>
  <div>
    さばえものづくり博覧会がオープンデータに！<br>
    ものづくりの魅力に触れ、鯖江のこれからを共に創ろう！
  </div>
  
  <div id="div_search">
    <div id="div_search_box">
    <input type="text" id="input_search"><button id="btn_search"></button>
    </div>
    <div>&gt; <a href="https://push.sabae.cc/524">オープンデータについて</a></div>
    <div id="all"></div>
</div>
  
  

  <a name="member"></a>
  <div id="main">
    <div>
      <h3>タグから探す</h3>
      <div id="tags"></div>
      <br>
      <div id="alltags"></div>
    </div>
	<div>
		<h3>地図から探す</h3>
		<div id="divmap"></div>
		<div id="amap">→<a href=map.html>マップを大きくみる</a></div>
	</div>
    <a name="news"></a>
    <div>
      <h3>新着情報</h3>
      <div id="divnews">
      </div>
    </div>

    <a name="newimg"></a>
    <div>
      <h3>新着画像</h3>
      <div id="divnewsimg">
      </div>
    </div>

    <a name="information"></a>
    <div>
      <h3>INFORMATION</h3>
      <div id="info">
        <a href="https://nt.sabae.cc/">2020-10-03 技術の祭典「NT鯖江2020」開催!</a><br>
        <a href="https://github.com/code4sabae/sabae-monohaku.jp/">2020-08-12 本WebサイトをGitHubにてオープンソースとして公開</a><br>
      </div>
    </div>

    
    <!--
    <div>
      <h3>新着画像</h3>
      <div id="news"></div>
    </div>
    -->
	<!--
    <div>
      <a name="greeting"></a>
      <h3>ご挨拶</h3>
      <div>
        2020年のものづくり博覧会は新型コロナウイルスの影響を鑑みて、<br>
        嚮陽会館で予定しておりました博覧会は中止とさせていただきました。<br>
        そして規模を縮小して、ウェブサイトでのみの開催とさせて頂きました。<br>
        皆様のご期待に添えない形での開催をご了承ください。<br>
        そのような中で私たちが鯖江の産業や事業者さん達のために<br>
        何が出来るのだろうと考えました。<br>
        さばえものづくり博覧会2020はこのウェブサイトをオープンデータ化し<br>
        皆さんのプラットフォームとして機能し、そして色んな方に活用、<br>
        参加していただける新しい形での開催をさせていただきます。<br>
        どうぞよろしくお願いします。
      </div>
    </div>
	-->
  </div>

  <smono-footer></smono-footer>

</body>
</html>
